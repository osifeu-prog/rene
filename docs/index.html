<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Rene - ××¢×¨×›×ª ×œ×™××•×“ ×ª×›× ×•×ª ××©×—×§×™×ª</title>
  <meta name="description" content="Rene â€” ×¤×ª×™×—×ª ×¤×¨×•×™×§×˜ ×¨××©×•×Ÿ ×‘×’×™×˜×”××‘, × ×§×•×“×•×ª XP, ×©×™×ª×•×¤×™× ×××™×ª×™×™×, ×”×–×× ×•×ª ×œ×—×‘×¨×™× ×•××¢×§×‘ ××“××™×Ÿ." />
  <style>
    :root{
      --bg1:#0e1123; --bg2:#1b1440;
      --accent:#ff4d8f; --accent2:#00ffe1;
      --text:#ffffff; --glass:rgba(255,255,255,0.10);
      --glass-strong:rgba(255,255,255,0.16);
      --shadow:0 10px 24px rgba(0,0,0,0.35);
      --radius:16px;
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0}
    body{
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      color:var(--text);
      background: radial-gradient(1200px 600px at 20% 10%, #2b1b56 0%, var(--bg1) 40%), linear-gradient(135deg, var(--bg1), var(--bg2));
      min-height:100vh; overflow-x:hidden; perspective: 1200px;
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }
    .container{max-width:1200px;margin:0 auto;padding:2rem}

    /* ×¨×§×¢ ×—×œ×§: ×—×œ×§×™×§×™× ×§×œ×™× + ×©×›×‘×•×ª ××•×¨×‘ */
    .bg{position:fixed;inset:0;z-index:-3;overflow:hidden}
    canvas#particles{position:absolute;inset:0;opacity:0.28;will-change:transform}
    .orb{
      position:absolute;width:280px;height:280px;border-radius:50%;
      background: radial-gradient(circle at 30% 30%, var(--accent2) 0%, #6a37ff 35%, transparent 70%);
      filter: blur(38px); mix-blend-mode: screen; will-change:transform;
      animation: orbMove 22s linear infinite;
    }
    .orb.orb2{background: radial-gradient(circle at 70% 30%, var(--accent) 0%, #ffb86b 40%, transparent 70%);animation-duration:28s}
    @keyframes orbMove{
      0%{transform: translate3d(8vw,10vh,0) rotate(0deg)}
      50%{transform: translate3d(72vw,28vh,0) rotate(180deg)}
      100%{transform: translate3d(8vw,10vh,0) rotate(360deg)}
    }
    .wave{
      position:absolute;left:0;right:0;bottom:-8vh;height:36vh;
      background: radial-gradient(closest-side at 20% 50%, rgba(255,255,255,0.06), transparent 60%),
                  radial-gradient(closest-side at 80% 50%, rgba(255,255,255,0.06), transparent 60%);
      filter: blur(16px); transform: translateZ(-200px); will-change:transform;
      animation: waveFloat 14s ease-in-out infinite;
    }
    @keyframes waveFloat{0%,100%{transform: translateY(0) translateZ(-200px)}50%{transform: translateY(-16px) translateZ(-200px)}}

    /* Hero 3D ×—×œ×§ */
    .hero{ text-align:center; padding:5rem 1rem 3rem; transform-style:preserve-3d; animation:fadeInUp .9s ease-out both }
    .title3d{
      display:inline-block; font-size: clamp(2rem,5vw,4rem);
      letter-spacing:.6px; background: linear-gradient(90deg,#fff,#c6fff7 30%,#ffd3e5 60%,#fff 90%);
      -webkit-background-clip:text; background-clip:text; color:transparent;
      text-shadow: 0 2px 0 rgba(0,0,0,0.25), 0 0 18px rgba(0,255,225,.35), 0 0 28px rgba(255,77,143,.30);
      transform: rotateX(5deg) rotateY(-6deg) translateZ(28px);
      animation: glowShift 3.6s ease-in-out infinite alternate;
      will-change:filter,transform;
    }
    .hero p{max-width:800px;margin:1rem auto 2rem;font-size:1.15rem;opacity:.92}

    @keyframes glowShift{from{filter: drop-shadow(0 0 6px var(--accent2))}to{filter: drop-shadow(0 0 12px var(--accent))}}
    @keyframes fadeInUp{from{opacity:0;transform:translate3d(0,16px,0)}to{opacity:1;transform:translate3d(0,0,0)}}

    /* ×›×¤×ª×•×¨×™× ×—×œ×§×™× ×¢× GPU */
    .btn{
      display:inline-block; padding:.9rem 1.4rem; border-radius:999px;
      background: linear-gradient(135deg, rgba(255,255,255,.12), rgba(255,255,255,.06));
      border:1px solid rgba(255,255,255,.22); color:#fff; text-decoration:none;
      margin:.4rem; position:relative; overflow:hidden; box-shadow: var(--shadow);
      backdrop-filter: blur(10px); transition: transform .24s cubic-bezier(.2,.8,.2,1), box-shadow .24s;
      cursor:pointer; will-change:transform;
    }
    .btn.primary{background: linear-gradient(135deg, var(--accent), #ff7bb0); box-shadow: 0 8px 24px rgba(255,77,143,.45)}
    .btn:hover{transform: translate3d(0,-4px,0) rotateX(1.5deg) rotateY(-1.5deg)}
    .btn:active{transform: translate3d(0,0,0)}
    /* Ripple */
    .btn::after{
      content:""; position:absolute; width:10px; height:10px; border-radius:50%; background:rgba(255,255,255,.6);
      transform: translate3d(var(--rx,0), var(--ry,0), 0) scale(0); opacity:0; pointer-events:none;
      transition: transform .6s ease, opacity .9s ease;
    }
    .btn.rippling::after{ transform: translate3d(var(--rx,0), var(--ry,0), 0) scale(22); opacity:.2 }

    /* ×›×¨×˜×™×¡×™× ×¢× Tilt ×—×œ×§ */
    .features{ display:grid; grid-template-columns:repeat(auto-fit,minmax(240px,1fr)); gap:1.2rem; margin:2rem 0 3rem }
    .card{
      background: var(--glass); border:1px solid rgba(255,255,255,.18);
      border-radius:var(--radius); padding:1.3rem; backdrop-filter: blur(12px);
      transform-style: preserve-3d; transition: transform .22s cubic-bezier(.2,.8,.2,1), box-shadow .22s;
      box-shadow: 0 8px 28px rgba(0,0,0,.25); position:relative; overflow:hidden; will-change:transform;
    }
    .card:hover{ transform: rotateX(4deg) rotateY(-4deg) translateZ(12px); box-shadow: 0 16px 36px rgba(0,0,0,.35) }
    .card h3{ margin:0 0 .6rem; font-size:1.25rem }
    .spark{ position:absolute; right:-18px; top:-18px; font-size:1.8rem; opacity:0; animation: sparkle 1.2s ease infinite; pointer-events:none }
    .card:hover .spark{ opacity:1 }
    @keyframes sparkle{0%{transform: scale(.6) rotate(0deg); opacity:.0}50%{transform: scale(1.15) rotate(180deg); opacity:.85}100%{transform: scale(.6) rotate(360deg); opacity:.0}}

    /* ××©×™××” ×¨××©×•× ×” */
    .task{ margin:3rem 0; padding:1.5rem; border-radius:var(--radius);
      background: var(--glass-strong); border:1px solid rgba(255,255,255,.18); box-shadow: var(--shadow) }
    .task h2{ margin:0 0 .6rem }
    .task ol{ margin:.6rem 0 0; padding-inline-start:1.2rem }
    .task li{ margin:.4rem 0 }
    .task code{ background: rgba(0,0,0,.35); padding:.2rem .4rem; border-radius:8px; border:1px solid rgba(255,255,255,.15); display:inline-block; direction:ltr }

    /* ××™× ×™-××©×—×§ ×§×œ×¤×™× */
    .game{ margin:2rem 0; text-align:center }
    .deck{ display:flex; flex-wrap:wrap; gap:.8rem; justify-content:center; margin-top:1rem }
    .game-card{
      min-width:220px; max-width:280px; flex:1 1 240px;
      background: var(--glass-strong); border:1px solid rgba(255,255,255,.22);
      border-radius:14px; padding:1rem; text-align:right; box-shadow: 0 10px 28px rgba(0,0,0,.28);
      transform-style: preserve-3d; transition: transform .22s cubic-bezier(.2,.8,.2,1), box-shadow .22s; will-change:transform,opacity;
    }
    .game-card.show{ transform: rotateY(0deg) translateZ(8px); opacity:1 }
    .game-card.hide{ transform: rotateY(80deg); opacity:.65 }

    .xp{
      display:inline-flex; align-items:center; gap:.4rem;
      background: rgba(0,255,225,.15); border:1px solid rgba(0,255,225,.35);
      color:#aafff5; border-radius:999px; padding:.2rem .6rem; font-weight:600; font-size:.95rem
    }

    /* ×©×™×ª×•×£ + Leaderboard */
    .share{ margin:2rem 0; text-align:center }
    .share input{
      min-width:280px; max-width:520px; width:60%; padding:.6rem; border-radius:12px;
      border:1px solid rgba(255,255,255,.25); background:rgba(255,255,255,.08); color:#fff; outline:none;
      transition: box-shadow .2s ease; box-shadow: 0 0 0 0 rgba(255,255,255,0)
    }
    .share input:focus{ box-shadow: 0 0 0 3px rgba(0,255,225,.22) }

    .leaderboard{
      margin:2rem 0; padding:1.4rem; border-radius:16px;
      background: var(--glass); border:1px solid rgba(255,255,255,.18)
    }
    .leaderboard h2{ text-align:center; margin:.2rem 0 1rem }
    .leaderboard ul{ list-style:none; margin:0; padding:0; display:grid; gap:.4rem }
    .leaderboard li{ background: rgba(255,255,255,.08); padding:.6rem .8rem; border-radius:12px }

    /* ××“××™×Ÿ */
    .admin{ margin:2.4rem 0; padding:1rem; border-radius:14px; background: rgba(255,255,255,.10); border:1px solid rgba(255,255,255,.18) }
    .admin h2{ margin:.2rem 0 1rem }
    .admin-grid{ display:grid; grid-template-columns: repeat(auto-fit, minmax(220px,1fr)); gap:.8rem }
    .admin-card{ background: rgba(255,255,255,.08); padding:.8rem; border-radius:10px }
    .admin small{ opacity:.8 }

    @media (max-width:768px){ .container{padding:1rem} .title3d{ transform: rotateX(4deg) rotateY(-3deg) translateZ(18px) } }

    /* × ×’×™×©×•×ª: ×”×¤×—×ª×ª ×ª× ×•×¢×” */
    @media (prefers-reduced-motion: reduce){
      *{ animation-duration:.001ms !important; animation-iteration-count:1 !important; transition-duration:.001ms !important }
    }
  </style>
</head>
<body>
  <!-- ×¨×§×¢ ×—×œ×§ -->
  <div class="bg">
    <canvas id="particles"></canvas>
    <div class="wave"></div>
    <div class="orb"></div>
    <div class="orb orb2"></div>
  </div>

  <div class="container">
    <section class="hero">
      <h1 class="title3d">ğŸ® Rene â€” ××¢×¨×›×ª ×œ×™××•×“ ×ª×›× ×•×ª ××©×—×§×™×ª</h1>
      <p>×¤×•×ª×—×™× ×¤×¨×•×™×§×˜ ×¨××©×•×Ÿ ×‘×’×™×˜×”××‘, ×¦×•×‘×¨×™× XP, ××–××™× ×™× ×—×‘×¨×™× ×¢× ×œ×™× ×§ ××™×©×™ ×•××—×‘×¨×™× ××ª ×“×£ ×”× ×—×™×ª×” ×©×œ×›× â€” ×”×›×œ ×‘××§×•× ××—×“ ×•×‘×× ×™××¦×™×•×ª ×—×œ×§×•×ª.</p>

      <!-- ×”×•×¡×¨ "×”×ª×—×œ ×œ×œ××•×“ ×¢×›×©×™×•"; × ×•×¡×¤×• ×”×¨×©××”/×¤×ª×™×—×ª ×¤×¨×•×™×§×˜/×—×™×‘×•×¨ -->
      <div>
        <a class="btn primary" href="https://github.com/signup" target="_blank" rel="noopener" data-track="signup">ğŸ§‘â€ğŸš€ ×”×™×¨×©× ×œ×’×™×˜×”××‘</a>
        <a class="btn" href="https://github.com/new" target="_blank" rel="noopener" data-track="newrepo">ğŸ“¦ ×¤×ª×— ××ª ×”×¤×¨×•×™×§×˜ ×”×¨××©×•×Ÿ ×©×œ×š</a>
        <button class="btn" id="connectRepoBtn" title="×—×™×‘×•×¨ ×“×£ ×”× ×—×™×ª×” ×œ×¤×¨×•×™×§×˜ ×©×œ×š">ğŸ”— ×—×‘×¨ ××ª ×”×“×£ ×œ×¤×¨×•×™×§×˜ ×©×œ×š</button>
      </div>
      <div style="margin-top:.6rem">
        <button class="btn" id="inviteBtn" title="×œ×™× ×§ ×”×–×× ×” ××™×©×™ ×œ×—×‘×¨">ğŸŸï¸ ×¦×•×¨ ×œ×™× ×§ ×”×–×× ×”</button>
        <span class="xp" id="xpBadge">XP: 0</span>
      </div>
    </section>

    <!-- ×¤×™×¦'×¨×™× -->
    <section class="features">
      <div class="card"><h3>ğŸ‘¨â€ğŸ’» ×œ××™×“×” ×—×•×•×™×™×ª×™×ª</h3><p>××©×—×§×™×•×ª, ××ª×’×¨×™× ×•× ×§×•×“×•×ª â€” ×‘×œ×™ ×©×™×¢×•×¨×™× ××©×¢×××™×.</p><div class="spark">âœ¨</div></div>
      <div class="card"><h3>ğŸ¯ ××©×™××•×ª ××¢×©×™×•×ª</h3><p>×›×œ ×¦×¢×“ = ×§×•×“ ×××™×ª×™ ×©×¨×¥ ×‘×“×¤×“×¤×Ÿ ×•×‘××—×©×‘.</p><div class="spark">âœ¨</div></div>
      <div class="card"><h3>ğŸƒ ××•×¡×£ ×§×œ×¤×™×</h3><p>×’×¨×œ×• ×§×œ×¤×™ ××ª×’×¨/×˜×™×¤×™× ×•×”×¨×•×•×™×—×• XP ×œ×›×œ ××©×™××”.</p><div class="spark">âœ¨</div></div>
      <div class="card"><h3>ğŸ“ˆ ××¢×§×‘ ×•×©×™×ª×•×¤×™×</h3><p>××ª×¢×“×›×Ÿ ×‘×–××Ÿ ×××ª: ××©×™××•×ª, XP ×•×©×™×ª×•×¤×™×.</p><div class="spark">âœ¨</div></div>
    </section>

    <!-- ××©×™××” ×¨××©×•× ×” -->
    <section class="task" id="firstTask">
      <h2>ğŸš€ ××©×™××” #1 â€” ×”×¤×¨×•×™×§×˜ ×”×¨××©×•×Ÿ ×©×œ×š ×‘×’×™×˜×”××‘</h2>
      <p>×”×¢××•×“ ×”×–×” ×™×”×™×” ×“×£ ×”× ×—×™×ª×” ×”×¨××©×•×Ÿ ×©×œ×š! ×ª×•×š ×›××” ×“×§×•×ª ×™×”×™×” ×œ×š ×¤×¨×•×™×§×˜ ×‘×’×™×˜×”××‘ ×¢× ×“×£ ×©×›×•×œ× ×™×›×•×œ×™× ×œ×¨××•×ª.</p>
      <ol>
        <li><strong>×¤×ª×— ××©×ª××©:</strong> ×œ×—×¥ ×¢×œ <a href="https://github.com/signup" target="_blank" rel="noopener">×”×¨×©××” ×œ×’×™×˜×”××‘</a> ×•×¡×™×™× ××ª ×”×”×¨×©××”.</li>
        <li><strong>×¦×•×¨ ×¨×™×¤×• ×—×“×©:</strong> ×œ×—×¥ ×¢×œ <a href="https://github.com/new" target="_blank" rel="noopener">×¤×ª×™×—×ª ×¤×¨×•×™×§×˜ ×—×“×©</a>.</li>
        <li><strong>×©× ×”×¨×™×¤×•:</strong> ×‘×—×¨ ×©× ×§×œ×™×˜, ×œ××©×œ <code>rene-first-project</code>.</li>
        <li><strong>×”×¢×œ×” ××ª ×”×§×•×‘×¥ ×”×–×”:</strong> ×¤×ª×— ××ª ×”×¨×™×¤×• ×•×œ×—×¥ ×¢×œ <em>Add file â†’ Create new file</em> ××• <em>Upload files</em>, ×•×”×“×‘×§/×”×¢×œ×” ××ª ×”×§×•×‘×¥ ×”×–×” ×‘×©× <code>index.html</code>.</li>
        <li><strong>×”×¤×¢×œ GitHub Pages:</strong> Settings â†’ Pages â†’ Source: Deploy from a branch, Branch: main, Folder: root. ×©××•×¨ â€” ×ª×§×‘×œ ×›×ª×•×‘×ª URL ×©×œ ×”×“×£ ×©×œ×š.</li>
        <li><strong>×—×‘×¨ ××ª ×”×“×£ ×›××Ÿ:</strong> ×œ×—×¥ ×¢×œ "<em>×—×‘×¨ ××ª ×”×“×£ ×œ×¤×¨×•×™×§×˜ ×©×œ×š</em>" ×•×”×“×‘×§ ××ª ×”Ö¾URL ×©×§×™×‘×œ×ª. ×–×” ×™×¢× ×™×§ ×œ×š XP ×•×™××¤×©×¨ ×©×™×ª×•×£ ××”×™×¨.</li>
      </ol>
      <p class="xp">+50 XP ×¢×œ ×¤×ª×™×—×ª ×”×¤×¨×•×™×§×˜ ×”×¨××©×•×Ÿ</p>
    </section>

    <!-- ××™× ×™-××©×—×§ ×§×œ×¤×™× -->
    <section class="game">
      <h2>ğŸ² ×’×¨×™×œ×ª ×§×œ×£ ×ª×›× ×•×ª</h2>
      <div>
        <button class="btn primary" id="drawCardBtn">×’×¨×™×œ ×§×œ×£!</button>
      </div>
      <div class="deck" id="deck"></div>
    </section>

    <!-- ×©×™×ª×•×£ -->
    <section class="share">
      <h2>ğŸ”— ×©×ª×¤×• ××ª ×”×¢××•×“ ×©×œ×›×</h2>
      <p>××—×¨×™ ×©×—×™×‘×¨×ª× ××ª ×“×£ ×”× ×—×™×ª×”, ×©×ª×¤×• ××•×ª×• ×¢× ×—×‘×¨×™× ×•×§×‘×œ×• ×¢×•×“ XP ×¢×œ ×›×œ ×”×¦×˜×¨×¤×•×ª!</p>
      <div>
        <input id="shareUrl" type="text" placeholder="×”×“×‘×™×§×• ×›××Ÿ ××ª ×›×ª×•×‘×ª ×”×“×£ ×©×œ×›× (GitHub Pages)"/>
        <button class="btn" id="saveShareUrl">ğŸ’¾ ×©××•×¨ ×›×ª×•×‘×ª</button>
        <button class="btn" id="copyShareUrl">ğŸ“£ ×”×¢×ª×§ ×§×™×©×•×¨ ×œ×©×™×ª×•×£</button>
      </div>
      <p class="xp" style="margin-top:.8rem">+10 XP ×¢×œ ×©×™×ª×•×£ ×¨××©×•×Ÿ</p>
    </section>

    <!-- Leaderboard -->
    <section class="leaderboard">
      <h2>ğŸ† ×œ×•×— ××•×‘×™×œ×™×</h2>
      <ul id="leaderList">
        <li>ğŸ¥‡ × ×•×¢×” â€” 120 XP</li>
        <li>ğŸ¥ˆ ×™×•××‘ â€” 95 XP</li>
        <li>ğŸ¥‰ ×“× ×” â€” 80 XP</li>
      </ul>
      <small style="opacity:.75">×‘×’×¨×¡×” ×–×• â€” ×¡× ×›×¨×•×Ÿ ×××™×ª×™ ×¢× ×”×©×¨×ª ×”×–××™×Ÿ.</small>
    </section>

    <!-- ××“××™×Ÿ -->
    <section class="admin" id="adminPanel" style="display:none">
      <h2>ğŸ› ï¸ ××“××™×Ÿ â€” ××¢×§×‘ ×”×¤×¦×” ×•×”×ª×§×“××•×ª</h2>
      <div class="admin-grid">
        <div class="admin-card"><strong>×ª×œ××™×“×™×</strong><div id="adminStudentsCount">0</div><small>× ×¨×©××• ×•×”×–×™× ×• URL</small></div>
        <div class="admin-card"><strong>×©×™×ª×•×¤×™×</strong><div id="adminShares">0</div><small>×”×¢×ª×§×•×ª ×§×™×©×•×¨ ×•×©×™×ª×•×¤×™× ×¨×©×•××™×</small></div>
        <div class="admin-card"><strong>XP ××¦×˜×‘×¨</strong><div id="adminTotalXP">0</div><small>×¡×›×•× ×œ×¤×™ ×©×¨×ª</small></div>
        <div class="admin-card"><strong>××©×™××•×ª ×”×•×©×œ××•</strong><div id="adminTasks">0</div><small>×¤×ª×™×—×ª ×¨×™×¤×• + ×—×™×‘×•×¨ ×“×£</small></div>
      </div>
      <div style="margin-top:.8rem">
        <button class="btn" id="exportData">â¬‡ï¸ ×™×™×¦× × ×ª×•× ×™× (JSON)</button>
      </div>
      <small style="display:block;margin-top:.6rem;opacity:.75">×›×“×™ ×œ×¤×ª×•×— ××ª ×¤×× ×œ ×”××“××™×Ÿ: ×”×•×¡×™×¤×• ?admin=1 ×œÖ¾URL ×©×œ ×”×¢××•×“.</small>
    </section>

    <footer style="text-align:center;margin:2.4rem 0 1rem;opacity:.8">
      <p>Â© 2025 Rene â€” ××¢×¨×›×ª ×œ×™××•×“ ×ª×›× ×•×ª ××©×—×§×™×ª</p>
    </footer>
  </div>

  <audio id="popSound" src="https://www.soundjay.com/buttons/sounds/button-16.mp3" preload="auto"></audio>

  <script>
    /* ×”×’×“×¨×•×ª API â€” ×”×ª×××” ×œ×¡×‘×™×‘×” ×©×œ×š */
    const API_BASE = (typeof window !== 'undefined' && window.location && window.location.origin) || 'https://rene-production.up.railway.app';
    const ENDPOINTS = {
      signup: API_BASE + '/api/signup',            // POST {referrerId?}
      newRepo: API_BASE + '/api/tasks/first-repo', // POST {userId}
      connectLanding: API_BASE + '/api/tasks/connect-landing', // POST {userId, url}
      shareCreate: API_BASE + '/api/share',        // POST {userId, url}
      shareCopy: API_BASE + '/api/share/copy',     // POST {userId}
      inviteLink: API_BASE + '/api/invite',        // POST {userId} -> {inviteUrl}
      progress: API_BASE + '/api/progress',        // GET -> {xp, tasks, shares, students}
      leaderboard: API_BASE + '/api/leaderboard',  // GET -> [{name,xp}]
      referral: API_BASE + '/api/referral'         // POST {referrerId, newUserFingerprint}
    };
    /* ×”×¢×¨×”: ×× ×™×© ×œ×š ×›×‘×¨ ××¡×œ×•×œ×™ API ×§×™×™××™× (Next.js / Supabase), ×›×•×•×Ÿ ××•×ª× ×›××Ÿ ×œ×©××•×ª ×‘×¤×•×¢×œ. */

    /* ×–×™×”×•×™ ××©×ª××© ××§×•××™ ×•×¤×™× ×’×¨×¤×¨×™× ×˜ ×“××” */
    const STORE_KEY = 'rene_app';
    const DEFAULT_DATA = { userId: null, xp: 0, tasks: { firstRepo:false, connectedLanding:false, firstShare:false }, shareUrl:'', inviteUrl:'', history:[] };
    const SFX = document.getElementById('popSound');

    function guid(){ return 'u_' + Math.random().toString(36).slice(2) + Date.now().toString(36); }
    function load(){
      try{ const raw = localStorage.getItem(STORE_KEY); return raw ? JSON.parse(raw) : {...DEFAULT_DATA}; }
      catch(e){ return {...DEFAULT_DATA}; }
    }
    function save(d){ localStorage.setItem(STORE_KEY, JSON.stringify(d)); }

    async function ensureUser(){
      const d = load();
      if(!d.userId){
        d.userId = guid();
        save(d);
        // ×”×¨×©××” ×œ×•×’×™×ª ×‘×©×¨×ª (××•×¤×¦×™×•× ×œ×™)
        try{
          const referrerId = new URLSearchParams(location.search).get('ref');
          await fetch(ENDPOINTS.signup, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ userId: d.userId, referrerId }) });
        }catch(err){}
      }
      return d.userId;
    }

    function setXP(xp){ const badge = document.getElementById('xpBadge'); badge.textContent = 'XP: ' + xp; badge.style.transform = 'scale(1.06)'; setTimeout(()=> badge.style.transform='scale(1)', 200); }

    /* ×—×œ×§×™×§×™× ×—×œ×§×™× â€” ×¤×—×•×ª × ×§×•×“×•×ª, ×§×•×•×™× ×‘×ª× ××™, rAF */
    function particles(){
      const canvas = document.getElementById('particles');
      const ctx = canvas.getContext('2d');
      let w = canvas.width = window.innerWidth;
      let h = canvas.height = window.innerHeight;
      let dpr = window.devicePixelRatio || 1;
      canvas.width = w * dpr; canvas.height = h * dpr; ctx.scale(dpr,dpr);

      window.addEventListener('resize', ()=>{
        w = canvas.width = window.innerWidth;
        h = canvas.height = window.innerHeight;
        canvas.width = w * dpr; canvas.height = h * dpr; ctx.setTransform(1,0,0,1,0,0); ctx.scale(dpr,dpr);
      });

      const PCOUNT = 68;
      const ps = new Array(PCOUNT).fill(0).map(()=>({
        x: Math.random()*w, y: Math.random()*h,
        r: Math.random()*1.7 + 0.7,
        vx: (Math.random()-0.5)*0.32,
        vy: (Math.random()-0.5)*0.32,
        c: Math.random()<.5 ? 'rgba(0,255,225,.7)' : 'rgba(255,77,143,.65)'
      }));
      function step(){
        ctx.clearRect(0,0,w,h);
        for(const p of ps){
          p.x += p.vx; p.y += p.vy;
          if(p.x<0||p.x>w) p.vx*=-1;
          if(p.y<0||p.y>h) p.vy*=-1;
          ctx.beginPath(); ctx.arc(p.x, p.y, p.r, 0, Math.PI*2); ctx.fillStyle = p.c; ctx.fill();
        }
        // ×§×•×•×™× ×¨×§ ×›××©×¨ ×§×¨×•×‘ ×•×‘×˜×•×•×—
        for(let i=0;i<PCOUNT;i++){
          const a=ps[i];
          for(let j=i+1;j<PCOUNT;j++){
            const b=ps[j];
            const dx=a.x-b.x, dy=a.y-b.y, dist2 = dx*dx + dy*dy;
            if(dist2 < 110*110){
              ctx.strokeStyle = 'rgba(255,255,255,0.06)';
              ctx.lineWidth = 0.5; ctx.beginPath(); ctx.moveTo(a.x,a.y); ctx.lineTo(b.x,b.y); ctx.stroke();
            }
          }
        }
        requestAnimationFrame(step);
      }
      step();
    }

    /* Tilt ×—×œ×§ ×¢×œ ×¤×™ ×¢×›×‘×¨ */
    function tilt3D(){
      const hero = document.querySelector('.hero');
      const cards = ()=> document.querySelectorAll('.card, .game-card');
      let ticking = false;
      function onMove(e){
        if(ticking) return;
        ticking = true;
        requestAnimationFrame(()=>{
          const tilt = (el)=>{
            const rect = el.getBoundingClientRect();
            const cx = rect.left + rect.width/2;
            const cy = rect.top + rect.height/2;
            const dx = (e.clientX - cx)/rect.width;
            const dy = (e.clientY - cy)/rect.height;
            el.style.transform = `rotateX(${dy*-4}deg) rotateY(${dx*4}deg) translateZ(12px)`;
          };
          tilt(hero);
          cards().forEach(c=> tilt(c));
          ticking = false;
        });
      }
      document.addEventListener('mousemove', onMove, {passive:true});
      document.addEventListener('mouseleave', ()=>{
        hero.style.transform=''; cards().forEach(c=> c.style.transform='');
      });
    }

    /* Ripple ×—×œ×§ */
    document.addEventListener('click', (e)=>{
      const btn = e.target.closest('.btn');
      if(!btn) return;
      const rect = btn.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;
      btn.style.setProperty('--rx', x+'px');
      btn.style.setProperty('--ry', y+'px');
      btn.classList.add('rippling');
      setTimeout(()=> btn.classList.remove('rippling'), 300);
    }, {passive:true});

    /* ×§×œ×¤×™× ×•××ª×’×¨×™× */
    const cards = [
      { title:"ğŸ’¡ ×¤×•× ×§×¦×™×” ×›×¤×•×œ 2", text:"×›×ª×‘×• ×¤×•× ×§×¦×™×” ×©××—×–×™×¨×” ××¡×¤×¨ ×›×¤×•×œ 2." , xp:5 },
      { title:"ğŸ”¥ × ×™×—×•×© ××¡×¤×¨×™×", text:"×¦×¨×• ××©×—×§ ×©××’×¨×™×œ ××¡×¤×¨ 1-50 ×•××ª× ×× ×—×©×™×." , xp:10 },
      { title:"ğŸ§© ×ª× ××™× ×¢× if", text:"×”×•×¡×™×¤×• ×‘×“×™×§×•×ª ×œ×•×’×™×•×ª ×œ×§×œ×˜ ×”××©×ª××©." , xp:5 },
      { title:"ğŸš€ ×œ×•×œ××” 1â†’10", text:"×¦×¨×• ×œ×•×œ××” ×©××“×¤×™×¡×” ××ª ×”××¡×¤×¨×™× 1 ×¢×“ 10." , xp:5 },
      { title:"ğŸ¨ ×¦×‘×¢ ×¨×§×¢ ×“×™× ××™", text:"×“×£ ×©××©× ×” ×¨×§×¢ ×›×œ 2 ×©× ×™×•×ª ×¢× JS." , xp:10 }
    ];
    function showCard(card){
      const deck = document.getElementById('deck');
      const el = document.createElement('div');
      el.className = 'game-card hide';
      el.innerHTML = `
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:.4rem">
          <strong>${card.title}</strong>
          <span class="xp">+${card.xp} XP</span>
        </div>
        <div>${card.text}</div>
      `;
      deck.prepend(el);
      requestAnimationFrame(()=>{ el.classList.remove('hide'); el.classList.add('show'); });
    }

    async function drawCard(){
      const d = load();
      const i = Math.floor(Math.random() * cards.length);
      const c = cards[i];
      SFX.currentTime = 0; SFX.play();
      showCard(c);
      try{
        await fetch(ENDPOINTS.progress, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ userId:d.userId, xp:c.xp, event:'draw_card', title:c.title }) });
        await refreshProgress();
      }catch(err){}
    }

    /* ××©×™××” ×¨××©×•× ×”: ×¡×™××•×Ÿ ×¤×ª×™×—×ª ×¨×™×¤×• */
    document.querySelectorAll('[data-track]').forEach(el=>{
      el.addEventListener('click', async ()=>{
        const d = load();
        const action = el.getAttribute('data-track');
        await ensureUser();
        if(action === 'signup'){
          try{ await fetch(ENDPOINTS.signup, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ userId:d.userId }) }); }catch(err){}
        }
        if(action === 'newrepo' && !d.tasks.firstRepo){
          d.tasks.firstRepo = true; save(d);
          try{ await fetch(ENDPOINTS.newRepo, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ userId:d.userId }) }); await refreshProgress(); }catch(err){}
          setTimeout(()=> alert('×›×œ ×”×›×‘×•×“! +50 XP ×¢×œ ×¤×ª×™×—×ª ×”×¤×¨×•×™×§×˜ ×”×¨××©×•×Ÿ ğŸ‰'), 30);
        }
      }, {passive:true});
    });

    /* ×—×™×‘×•×¨ ×“×£ × ×—×™×ª×” */
    const connectBtn = document.getElementById('connectRepoBtn');
    connectBtn.addEventListener('click', async ()=>{
      const url = prompt('×”×“×‘×™×§×• ×›××Ÿ ××ª ×›×ª×•×‘×ª GitHub Pages ×©×œ ×”×¤×¨×•×™×§×˜ ×©×œ×›×:');
      if(!url) return;
      await ensureUser();
      const d = load();
      d.shareUrl = url.trim(); d.tasks.connectedLanding = true; save(d);
      document.getElementById('shareUrl').value = d.shareUrl;
      try{
        await fetch(ENDPOINTS.connectLanding, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ userId:d.userId, url: d.shareUrl }) });
        await refreshProgress();
      }catch(err){}
      alert('×”×“×£ ×—×•×‘×¨ ×‘×”×¦×œ×—×”! ×ª×•×›×œ×• ×œ×©×ª×£ ××•×ª×• ×•×œ×¦×‘×•×¨ XP.');
    });

    /* ×©××™×¨×ª/×”×¢×ª×§×ª ×›×ª×•×‘×ª ×©×™×ª×•×£ */
    const saveShareBtn = document.getElementById('saveShareUrl');
    const copyShareBtn = document.getElementById('copyShareUrl');
    const shareInput = document.getElementById('shareUrl');

    saveShareBtn.addEventListener('click', async ()=>{
      const val = (shareInput.value || '').trim();
      if(!val){ alert('× × ×œ×”×–×™×Ÿ ×›×ª×•×‘×ª ×ª×§×™× ×” ×©×œ GitHub Pages.'); return; }
      await ensureUser();
      const d = load();
      d.shareUrl = val; d.tasks.connectedLanding = true; save(d);
      try{
        await fetch(ENDPOINTS.connectLanding, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ userId:d.userId, url: d.shareUrl }) });
        await refreshProgress();
      }catch(err){}
      alert('× ×©××¨! ×¢×›×©×™×• ××¤×©×¨ ×œ×©×ª×£ ×‘×§×œ×™×§.');
    });

    copyShareBtn.addEventListener('click', async ()=>{
      const d = load();
      if(!d.shareUrl){ alert('××™×Ÿ ×›×ª×•×‘×ª ×©××•×¨×”. ×”×–×™× ×• ××ª ×›×ª×•×‘×ª ×”Ö¾GitHub Pages ×©×œ×›×.'); return; }
      try{
        await navigator.clipboard.writeText(d.shareUrl);
        await ensureUser();
        await fetch(ENDPOINTS.shareCopy, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ userId:d.userId }) });
        // XP ×œ×©×™×ª×•×£ ×¨××©×•×Ÿ â€” ××”×©×¨×ª
        await refreshProgress();
        alert('×”×§×™×©×•×¨ ×”×•×¢×ª×§! ×©×ª×¤×• ××•×ª×• ×‘×•×•×˜×¡××¤/×§×‘×•×¦×•×ª ğŸ˜‰');
      }catch(err){ alert('×œ× ×”×¦×œ×—×ª×™ ×œ×”×¢×ª×™×§. × ×¡×• ×™×“× ×™×ª.'); }
    });

    /* ×œ×™× ×§ ×”×–×× ×” ××™×©×™ â€” ×›×œ ×—×‘×¨ ×—×“×© ××’×™×¢ ×¢× ?ref=<userId> */
    const inviteBtn = document.getElementById('inviteBtn');
    inviteBtn.addEventListener('click', async ()=>{
      await ensureUser();
      const d = load();
      try{
        const res = await fetch(ENDPOINTS.inviteLink, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ userId:d.userId }) });
        const j = await res.json();
        const url = j.inviteUrl || (location.origin + location.pathname + '?ref=' + d.userId);
        d.inviteUrl = url; save(d);
        await navigator.clipboard.writeText(url);
        alert('×œ×™× ×§ ×”×”×–×× ×” ×”×•×¢×ª×§! ×©×œ×—×• ×œ×—×‘×¨×™×: ' + url);
      }catch(err){
        const url = location.origin + location.pathname + '?ref=' + d.userId;
        d.inviteUrl = url; save(d);
        await navigator.clipboard.writeText(url);
        alert('×œ×™× ×§ ×”×”×–×× ×” ×”×•×¢×ª×§! ×©×œ×—×• ×œ×—×‘×¨×™×: ' + url);
      }
    });

    /* ×¨×™×©×•× ×”×¦×˜×¨×¤×•×ª ×—×‘×¨ ×—×“×© (referral) */
    async function captureReferral(){
      const params = new URLSearchParams(location.search);
      const ref = params.get('ref');
      if(!ref) return;
      const myFingerprint = guid();
      try{
        await fetch(ENDPOINTS.referral, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ referrerId: ref, newUserFingerprint: myFingerprint }) });
      }catch(err){}
    }

    /* Leaderboard ×××™×ª×™ ××”×©×¨×ª */
    async function renderLeaderboardServer(){
      try{
        const res = await fetch(ENDPOINTS.leaderboard);
        const list = document.getElementById('leaderList');
        if(!res.ok) throw new Error('leaderboard not ok');
        const arr = await res.json();
        list.innerHTML = arr.map(x=> `<li>${x.rankIcon || 'ğŸ”¹'} ${x.name} â€” ${x.xp} XP</li>`).join('');
      }catch(err){
        // ×× × ×›×©×œ, × ××©×™×š ×¢× ×‘×¨×™×¨×ªÖ¾××—×“×œ
      }
    }

    /* ××“××™×Ÿ: × ×ª×•× ×™ ×”×ª×§×“××•×ª ××”×©×¨×ª */
    function isAdmin(){ return new URLSearchParams(location.search).get('admin') === '1'; }
    async function renderAdmin(){
      const panel = document.getElementById('adminPanel');
      if(!isAdmin()){ panel.style.display='none'; return; }
      panel.style.display='block';
      try{
        const res = await fetch(ENDPOINTS.progress);
        const data = await res.json();
        document.getElementById('adminStudentsCount').textContent = data.students || 0;
        document.getElementById('adminShares').textContent = data.shares || 0;
        document.getElementById('adminTotalXP').textContent = data.totalXP || 0;
        document.getElementById('adminTasks').textContent = data.tasksCompleted || 0;
        document.getElementById('exportData').onclick = async ()=>{
          const res2 = await fetch(ENDPOINTS.progress + '?export=1');
          const blob = await res2.blob();
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url; a.download = 'rene_server_data.json'; a.click();
          URL.revokeObjectURL(url);
        };
      }catch(err){}
    }

    /* ×¨×¢× ×•×Ÿ XP/××¦×‘ ××”×©×¨×ª */
    async function refreshProgress(){
      try{
        const res = await fetch(ENDPOINTS.progress);
        const j = await res.json();
        setXP(j.xp || 0);
      }catch(err){}
    }

    /* ××ª×—×•×œ */
    (async function init(){
      await ensureUser();
      await captureReferral();
      particles();
      tilt3D();
      await refreshProgress();
      await renderLeaderboardServer();

      // ×˜×¢×™× ×ª ×›×ª×•×‘×ª ×“×£ ×× ×§×™×™××ª
      const d = load();
      if(d.shareUrl) document.getElementById('shareUrl').value = d.shareUrl;

      // ××™×¨×•×¢ ×’×¨×™×œ×ª ×§×œ×£
      document.getElementById('drawCardBtn').addEventListener('click', drawCard);

      // ××“××™×Ÿ
      await renderAdmin();
    })();
  </script>
</body>
</html>
